"use strict";(self.webpackChunkarrow_website=self.webpackChunkarrow_website||[]).push([[9572],{58973:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>h,frontMatter:()=>r,metadata:()=>a,toc:()=>d});var o=t(85893),s=t(11151);const r={title:"... with Ktor",sidebar_position:1},i="SuspendApp with Ktor",a={id:"learn/coroutines/suspendapp/ktor",title:"... with Ktor",description:"There are some cases where it is convenient to gracefully shutdown a Ktor server. Basically, it is about giving some",source:"@site/content/docs/learn/coroutines/suspendapp/ktor.md",sourceDirName:"learn/coroutines/suspendapp",slug:"/learn/coroutines/suspendapp/ktor",permalink:"/learn/coroutines/suspendapp/ktor",draft:!1,unlisted:!1,editUrl:"https://github.com/arrow-kt/arrow-website/edit/main/content/docs/learn/coroutines/suspendapp/ktor.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{title:"... with Ktor",sidebar_position:1},sidebar:"learnSidebar",previous:{title:"Graceful shutdown",permalink:"/learn/coroutines/suspendapp/"},next:{title:"... with Kafka",permalink:"/learn/coroutines/suspendapp/kafka"}},c={},d=[];function l(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,s.a)(),...e.components};return(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(n.h1,{id:"suspendapp-with-ktor",children:"SuspendApp with Ktor"}),"\n",(0,o.jsx)(n.p,{children:"There are some cases where it is convenient to gracefully shutdown a Ktor server. Basically, it is about giving some\ntime to the server to finish some pending processing before turning it off."}),"\n",(0,o.jsxs)(n.p,{children:["Kubernetes is a good example of this need. When we're working with Kubernetes we often need to\nsupport ",(0,o.jsx)(n.a,{href:"https://cloud.google.com/blog/products/containers-kubernetes/kubernetes-best-practices-terminating-with-grace",children:"Graceful Shutdown"}),".\nKubernetes sends ",(0,o.jsx)(n.code,{children:"SIGTERM"})," to our ",(0,o.jsx)(n.em,{children:"Pod"})," to signal it needs to gracefully shutdown.\nHowever, there is an issue which doesn't allow us to immediately shutdown when we receive ",(0,o.jsx)(n.code,{children:"SIGTERM"})," from Kubernetes.\nOur pod can still receive traffic ",(0,o.jsx)(n.strong,{children:"after"})," ",(0,o.jsx)(n.code,{children:"SIGTERM"}),", so we need to apply additional back-pressure to delay graceful\nshutdown."]}),"\n",(0,o.jsx)(n.admonition,{title:"Additional reading",type:"info",children:(0,o.jsxs)(n.p,{children:["More information on this can be found in this blog by ",(0,o.jsx)(n.a,{href:"https://philpearl.github.io/post/k8s_ingress/",children:"Phil Pearl"}),",\nand on ",(0,o.jsx)(n.a,{href:"https://learnk8s.io/graceful-shutdown",children:"learnk8s.io"}),"."]})}),"\n",(0,o.jsxs)(n.p,{children:["The module ",(0,o.jsx)(n.code,{children:"suspendapp-ktor"})," provides a ",(0,o.jsx)(n.code,{children:"server"})," constructor that lifts the Ktor ",(0,o.jsx)(n.code,{children:"ApplicationEngine"})," in to a Resource,\nrepresenting the ",(0,o.jsx)(n.em,{children:"Engine"})," running an ",(0,o.jsx)(n.code,{children:"Application"}),"(i.e ",(0,o.jsx)(n.code,{children:"Netty"}),") while supporting ",(0,o.jsx)(n.a,{href:"https://ktor.io/docs/auto-reload.html",children:"auto-reload"}),".\nThe example below introduces graceful shutdown for Kubernetes;\nwe additionally use ",(0,o.jsx)(n.code,{children:"awaitCancellation"})," to ",(0,o.jsx)(n.em,{children:"await"})," ",(0,o.jsx)(n.code,{children:"SIGTERM"}),", ",(0,o.jsx)(n.code,{children:"SIGINT"})," or other shutdown hooks."]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-kotlin",children:'fun main() = SuspendApp {\n  resourceScope {\n    server(Netty) {\n      routing {\n        get("/ping") {\n          call.respond("pong")\n        }\n      }\n    }\n    awaitCancellation()\n  }\n}\n'})}),"\n",(0,o.jsxs)(n.p,{children:["When the ",(0,o.jsx)(n.code,{children:"release"})," function of our ",(0,o.jsx)(n.code,{children:"ApplicationEngine"})," is called, there is a ",(0,o.jsx)(n.code,{children:"wait"})," period before the beginning of the stop\nprocess (defaulted to ",(0,o.jsx)(n.code,{children:"30.seconds"}),"), this gives Kubernetes enough time to do all its network management before we shut down.\nTwo more parameters are available:"]}),"\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"grace"})," which sets the number of seconds during which already inflight requests are allowed to continue before the shutdown process begins,"]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"timeout"})," which sets the number of seconds after which the server will be forceably shutdown."]}),"\n"]}),"\n",(0,o.jsx)(n.admonition,{title:"Development mode",type:"note",children:(0,o.jsxs)(n.p,{children:["In the case that Ktor server is set in\n",(0,o.jsx)(n.a,{href:"https://ktor.io/docs/development-mode.html",children:"development mode"}),", the ",(0,o.jsx)(n.code,{children:"wait"})," period is ignored."]})})]})}function h(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(l,{...e})}):l(e)}},11151:(e,n,t)=>{t.d(n,{Z:()=>a,a:()=>i});var o=t(67294);const s={},r=o.createContext(s);function i(e){const n=o.useContext(r);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),o.createElement(r.Provider,{value:n},e.children)}}}]);