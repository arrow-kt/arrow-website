"use strict";(self.webpackChunkarrow_website=self.webpackChunkarrow_website||[]).push([["2593"],{35538:function(e,n,i){i.r(n),i.d(n,{metadata:()=>t,default:()=>u,frontMatter:()=>o,contentTitle:()=>l,toc:()=>c,assets:()=>a});var t=JSON.parse('{"id":"learn/coroutines/suspendapp/index","title":"Graceful shutdown","description":"When building applications that require graceful shutdown it typically requires us to write a lot of platform-specific","source":"@site/content/docs/learn/coroutines/suspendapp/index.md","sourceDirName":"learn/coroutines/suspendapp","slug":"/learn/coroutines/suspendapp/","permalink":"/learn/coroutines/suspendapp/","draft":false,"unlisted":false,"tags":[],"version":"current","frontMatter":{"title":"Graceful shutdown"},"sidebar":"learnSidebar","previous":{"title":"Resource","permalink":"/learn/coroutines/resource-safety"},"next":{"title":"... with Ktor","permalink":"/learn/coroutines/suspendapp/ktor"}}'),r=i(74848),s=i(28453);i(7804);let o={title:"Graceful shutdown"},l="Graceful shutdown",a={},c=[{value:"Simple example",id:"simple-example",level:2},{value:"SuspendApp Arrow&#39;s Resource",id:"suspendapp-arrows-resource",level:2},{value:"Running on different platforms",id:"running-on-different-platforms",level:2},{value:"Node.js",id:"nodejs",level:3},{value:"Native",id:"native",level:3}];function d(e){let n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"graceful-shutdown",children:"Graceful shutdown"})}),"\n",(0,r.jsx)(n.p,{children:"When building applications that require graceful shutdown it typically requires us to write a lot of platform-specific\ncode. This library aims to solve that problem by leveraging Kotlin MPP using KotlinX Coroutines, and Structured Concurrency."}),"\n",(0,r.jsx)(n.admonition,{title:"Media resources",type:"info",children:(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://kotlindevday.com/videos/grateful-shutdown-with-structured-concurrency-simon-vergauwen/",children:(0,r.jsx)(n.em,{children:"Graceful Shutdown with Structured Concurrency"})})," by Simon Vergauwen"]}),"\n"]})}),"\n",(0,r.jsx)(n.h2,{id:"simple-example",children:"Simple example"}),"\n",(0,r.jsxs)(n.p,{children:["When you see ",(0,r.jsx)(n.code,{children:"App Started! Waiting until asked to shutdown."})," try pressing\n",(0,r.jsx)(n.em,{children:"Ctrl+C"})," to signal interruption (",(0,r.jsx)(n.code,{children:"SIGINT"}),") to the process.\nYou can also use ",(0,r.jsx)(n.code,{children:"ps -ax"})," to find the PID and call ",(0,r.jsx)(n.code,{children:"kill PID"})," to send a\n",(0,r.jsx)(n.code,{children:"SIGTERM"})," event to the process."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:'import arrow.continuations.SuspendApp\nimport kotlinx.coroutines.CancellationException\nimport kotlinx.coroutines.NonCancellable\nimport kotlinx.coroutines.delay\nimport kotlinx.coroutines.withContext\n\nfun main() = SuspendApp {\n  try {\n    println("App Started!  Waiting until asked to shutdown.")\n    while (true) {\n      delay(2_500)\n      println("Ping")\n    }\n  } catch (e: CancellationException) {\n    println("Cleaning up App... will take 10 seconds...")\n    withContext(NonCancellable) { delay(10_000) }\n    println("Done cleaning up. Will release app to exit")\n  }\n}\n'})}),"\n",(0,r.jsx)(n.admonition,{type:"note",children:(0,r.jsxs)(n.p,{children:["Since our ",(0,r.jsx)(n.code,{children:"CoroutineScope"})," is cancelled we need to run our ",(0,r.jsx)(n.code,{children:"delay"})," in ",(0,r.jsx)(n.code,{children:"NonCancellable"}),"."]})}),"\n",(0,r.jsx)(n.h2,{id:"suspendapp-arrows-resource",children:"SuspendApp Arrow's Resource"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.a,{href:"../../../learn/coroutines/resource-safety/",children:"Resource"}),"\nallows for modeling resources within the ",(0,r.jsx)(n.code,{children:"suspend"})," world,\nand properly takes into account structured concurrency and cancellation.\nThis means that when a ",(0,r.jsx)(n.code,{children:"CoroutineScope"})," gets cancelled, then any ",(0,r.jsx)(n.em,{children:"suspend finalizer"})," will ",(0,r.jsx)(n.em,{children:"back pressure"})," ",(0,r.jsx)(n.code,{children:"Job#join"}),".\nAnd thus when you call ",(0,r.jsx)(n.code,{children:"cancelAndJoin"})," on a ",(0,r.jsx)(n.code,{children:"CoroutineScope"})," it will properly await the ",(0,r.jsx)(n.code,{children:"finalizers"})," to have finished\nrunning."]}),"\n",(0,r.jsxs)(n.p,{children:["With SuspendApp this means that if someone sends a terminal signal such as ",(0,r.jsx)(n.code,{children:"SIGINT"})," or ",(0,r.jsx)(n.code,{children:"SIGTERM"})," to the application\nthen it will run all the ",(0,r.jsx)(n.em,{children:"suspend finalizers"})," before closing the application."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-kotlin",children:'fun main() = SuspendApp {\n  resourceScope {\n    install({ println("Creating some resource") }) { _, exitCase ->\n      println("ExitCase: $exitCase")\n      println("Shutting down will take 10 seconds")\n      delay(10_000)\n      println("Shutdown finished")\n    }\n    println("Application running with acquired resources.")\n    awaitCancellation()\n  }\n}\n'})}),"\n",(0,r.jsxs)(n.p,{children:["In the example above we have a ",(0,r.jsx)(n.code,{children:"Resource"})," that during ",(0,r.jsx)(n.em,{children:"acquisition"})," will print ",(0,r.jsx)(n.code,{children:"Creating some resource"}),",\nwhen the ",(0,r.jsx)(n.code,{children:"Resource"})," needs to be closed, ",(0,r.jsx)(n.em,{children:"release"}),", we print the ",(0,r.jsx)(n.code,{children:"ExitCase"})," with which the ",(0,r.jsx)(n.code,{children:"Resource"})," was closed, and\nthen we wait for 10 seconds. The ",(0,r.jsx)(n.code,{children:"Resource"})," already takes care of calling ",(0,r.jsx)(n.code,{children:"release"})," on a ",(0,r.jsx)(n.code,{children:"NonCancellable"})," context."]}),"\n",(0,r.jsxs)(n.p,{children:["We consume the ",(0,r.jsx)(n.code,{children:"Resource"})," until our application is cancelled by calling ",(0,r.jsx)(n.code,{children:"awaitCancellation"})," from KotlinX Coroutines.\nThat gives us the following output, if you press ",(0,r.jsx)(n.em,{children:"Ctrl+C"})," in the terminal."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-text",children:"Creating some resource\nApplication running with acquired resources.\n^CExitCase: Cancelled(exception=kotlinx.coroutines.JobCancellationException: LazyStandaloneCoroutine was cancelled; job=LazyStandaloneCoroutine{Cancelling}@f7470010)\nShutting down will take 10 seconds\nShutdown finished\n"})}),"\n",(0,r.jsx)(n.admonition,{type:"tip",children:(0,r.jsxs)(n.p,{children:["You can find this example in the ",(0,r.jsx)(n.a,{href:"https://github.com/arrow-kt/suspendapp/tree/main/example",children:"repository"}),", currently setup for NodeJS and native targets."]})}),"\n",(0,r.jsx)(n.h2,{id:"running-on-different-platforms",children:"Running on different platforms"}),"\n",(0,r.jsxs)(n.p,{children:["For more details on Kotlin Multiplatform configuration consult the ",(0,r.jsx)(n.a,{href:"https://kotlinlang.org/docs/multiplatform.html",children:"official documentation"}),".\nJust ",(0,r.jsx)(n.code,{children:"./gradlew build"})," the project, and launch the created binaries as shown in the sections below."]}),"\n",(0,r.jsxs)(n.admonition,{title:"Currently supported targets",type:"note",children:[(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"JVM"}),"\n",(0,r.jsx)(n.li,{children:"MacOsX64 & MacosArm64"}),"\n",(0,r.jsx)(n.li,{children:"NodeJS"}),"\n",(0,r.jsx)(n.li,{children:"Windows (MingwX64)"}),"\n",(0,r.jsx)(n.li,{children:"Linux"}),"\n"]}),(0,r.jsxs)(n.p,{children:["SuspendApp currently does not support any mobile or browser targets because it does not make sense to have such\napplication behavior on such platforms. If you have a use-case for this please ",(0,r.jsx)(n.a,{href:"https://github.com/arrow-kt/suspendapp/issues",children:"open a ticket"}),"!"]})]}),"\n",(0,r.jsx)(n.h3,{id:"nodejs",children:"Node.js"}),"\n",(0,r.jsx)(n.p,{children:"Make sure you configure your NodeJS app to be executable."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"js(IR) {\n  nodejs {\n    binaries.executable()\n  }\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["You can run your NodeJS app with the following ",(0,r.jsx)(n.code,{children:"node"})," command,\nand if you press ",(0,r.jsx)(n.em,{children:"Ctrl+C"})," within the first 2500ms you will see the following output."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-text",children:"node build/js/packages/YourAppName/kotlin/YourAppName.js\n\nApp Started! Waiting until asked to shutdown.\n^CCleaning up App... will take 10 seconds...\nDone cleaning up. Will release app to exit\n"})}),"\n",(0,r.jsx)(n.h3,{id:"native",children:"Native"}),"\n",(0,r.jsx)(n.p,{children:"Make sure you configure your Native app(s) to be executable."}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"linuxX64 {\n  binaries.executable()\n}\nmingwX64 {\n  binaries.executable()\n}\nmacosArm64 {\n  binaries.executable()\n}\nmacosX64 {\n  binaries.executable()\n}\n"})}),"\n",(0,r.jsxs)(n.p,{children:["You can run your Native app with the following command,\nand if you press ",(0,r.jsx)(n.em,{children:"Ctrl+C"})," within the first 2500ms you will see the following output."]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-text",children:"./gradlew build\nbuild/bin/native/releaseExecutable/YourAppName.kexe\n\nApp Started! Waiting until asked to shutdown.\n^CCleaning up App... will take 10 seconds...\nDone cleaning up. Will release app to exit\n"})})]})}function u(e={}){let{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},77488:function(e,n,i){i.d(n,{V:()=>a});var t=i(74848);i(96540);var r=i(95310),s=i(66497);function o({href:e,children:n}){return(0,t.jsx)(r.A,{href:e,className:"linkCard_uxt7",children:n})}function l({title:e,icon:n,body:i}){return(0,t.jsxs)("div",{className:"card",children:[(0,t.jsxs)("div",{className:"card__header cardHeader_NaDd",children:[(0,t.jsx)("img",{className:"icon_lqTJ",src:(0,s.Ay)(`/img/${n}`),alt:`${e} category`,title:`${e} category`,width:"48px",height:"48px"}),(0,t.jsx)("h2",{title:e,className:"text--truncate",children:e})]}),(0,t.jsx)("div",{className:"card__body cardBody_svEQ",children:(0,t.jsx)("p",{className:"paragraph_UbEf",children:i})})]})}let a=e=>(0,t.jsx)(o,{href:e.href,children:(0,t.jsx)(l,{...e})})},7804:function(e,n,i){i.d(n,{A:()=>c});var t=i(74848);i(96540);var r=i(11988),s=i(88260),o=i(77488);function l({item:e}){let n=function(){try{return(0,r.$S)()}catch{return}}()?.customProps?.icon,i=e.label,l=e.customProps?.icon||n||"icon-tutorial.svg",a=e.href,c=e.customProps?.description??("link"===e.type&&(0,s.cC)(e.docId??void 0)).description??void 0;return(0,t.jsx)(o.V,{title:i,icon:l,href:a,body:c})}function a({className:e}){let n=(0,r.$S)();return(0,t.jsx)(c,{items:n.items,className:e})}function c(e){let{items:n,className:i}=e;if(!n)return(0,t.jsx)(a,{...e});let s=(0,r.d1)(n);return(0,t.jsx)("section",{className:`container_Mg1N ${i}`,children:s.map((e,n)=>(0,t.jsx)("article",{children:(0,t.jsx)(l,{item:e})},n))})}},28453:function(e,n,i){i.d(n,{R:()=>o,x:()=>l});var t=i(96540);let r={},s=t.createContext(r);function o(e){let n=t.useContext(s);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),t.createElement(s.Provider,{value:n},e.children)}}}]);