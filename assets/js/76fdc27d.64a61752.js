"use strict";(self.webpackChunkarrow_website=self.webpackChunkarrow_website||[]).push([[2815],{915:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>a,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>l,toc:()=>c});var t=i(85893),s=i(11151);i(97048);const r={title:"Graceful shutdown"},o="Graceful shutdown",l={id:"learn/coroutines/suspendapp/index",title:"Graceful shutdown",description:"When building applications that require graceful shutdown it typically requires us to write a lot of platform-specific",source:"@site/content/docs/learn/coroutines/suspendapp/index.md",sourceDirName:"learn/coroutines/suspendapp",slug:"/learn/coroutines/suspendapp/",permalink:"/learn/coroutines/suspendapp/",draft:!1,unlisted:!1,editUrl:"https://github.com/arrow-kt/arrow-website/edit/main/content/docs/learn/coroutines/suspendapp/index.md",tags:[],version:"current",frontMatter:{title:"Graceful shutdown"},sidebar:"learnSidebar",previous:{title:"Resource",permalink:"/learn/coroutines/resource-safety"},next:{title:"... with Ktor",permalink:"/learn/coroutines/suspendapp/ktor"}},a={},c=[{value:"Simple example",id:"simple-example",level:2},{value:"SuspendApp Arrow&#39;s Resource",id:"suspendapp-arrows-resource",level:2},{value:"Running on different platforms",id:"running-on-different-platforms",level:2},{value:"Node.js",id:"nodejs",level:3},{value:"Native",id:"native",level:3}];function d(e){const n={a:"a",admonition:"admonition",code:"code",em:"em",h1:"h1",h2:"h2",h3:"h3",li:"li",p:"p",pre:"pre",ul:"ul",...(0,s.a)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"graceful-shutdown",children:"Graceful shutdown"}),"\n",(0,t.jsx)(n.p,{children:"When building applications that require graceful shutdown it typically requires us to write a lot of platform-specific\ncode. This library aims to solve that problem by leveraging Kotlin MPP using KotlinX Coroutines, and Structured Concurrency."}),"\n",(0,t.jsx)(n.admonition,{title:"Media resources",type:"info",children:(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://kotlindevday.com/videos/grateful-shutdown-with-structured-concurrency-simon-vergauwen/",children:(0,t.jsx)(n.em,{children:"Graceful Shutdown with Structured Concurrency"})})," by Simon Vergauwen"]}),"\n"]})}),"\n",(0,t.jsx)(n.admonition,{title:"Where to find it",type:"note",children:(0,t.jsxs)(n.p,{children:["Graceful shutdowns are implemented in the ",(0,t.jsx)(n.code,{children:"suspendapp"})," library, with further integration with other frameworks available in their own libraries. For historical reasons, the ",(0,t.jsx)(n.code,{children:"suspendapp"})," library follows its own versioning scheme. Please check ",(0,t.jsx)(n.a,{href:"https://central.sonatype.com/artifact/io.arrow-kt/suspendapp",children:"Maven Central"})," for the latest release information."]})}),"\n",(0,t.jsx)(n.h2,{id:"simple-example",children:"Simple example"}),"\n",(0,t.jsxs)(n.p,{children:["When you see ",(0,t.jsx)(n.code,{children:"App Started! Waiting until asked to shutdown."})," try pressing\n",(0,t.jsx)(n.em,{children:"Ctrl+C"})," to signal interruption (",(0,t.jsx)(n.code,{children:"SIGINT"}),") to the process.\nYou can also use ",(0,t.jsx)(n.code,{children:"ps -ax"})," to find the PID and call ",(0,t.jsx)(n.code,{children:"kill PID"})," to send a\n",(0,t.jsx)(n.code,{children:"SIGTERM"})," event to the process."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-kotlin",children:'import arrow.continuations.SuspendApp\nimport kotlinx.coroutines.CancellationException\nimport kotlinx.coroutines.NonCancellable\nimport kotlinx.coroutines.delay\nimport kotlinx.coroutines.withContext\n\nfun main() = SuspendApp {\n  try {\n    println("App Started!  Waiting until asked to shutdown.")\n    while (true) {\n      delay(2_500)\n      println("Ping")\n    }\n  } catch (e: CancellationException) {\n    println("Cleaning up App... will take 10 seconds...")\n    withContext(NonCancellable) { delay(10_000) }\n    println("Done cleaning up. Will release app to exit")\n  }\n}\n'})}),"\n",(0,t.jsx)(n.admonition,{type:"note",children:(0,t.jsxs)(n.p,{children:["Since our ",(0,t.jsx)(n.code,{children:"CoroutineScope"})," is cancelled we need to run our ",(0,t.jsx)(n.code,{children:"delay"})," in ",(0,t.jsx)(n.code,{children:"NonCancellable"}),"."]})}),"\n",(0,t.jsx)(n.h2,{id:"suspendapp-arrows-resource",children:"SuspendApp Arrow's Resource"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.a,{href:"../../../learn/coroutines/resource-safety/",children:"Resource"}),"\nallows for modeling resources within the ",(0,t.jsx)(n.code,{children:"suspend"})," world,\nand properly takes into account structured concurrency and cancellation.\nThis means that when a ",(0,t.jsx)(n.code,{children:"CoroutineScope"})," gets cancelled, then any ",(0,t.jsx)(n.em,{children:"suspend finalizer"})," will ",(0,t.jsx)(n.em,{children:"back pressure"})," ",(0,t.jsx)(n.code,{children:"Job#join"}),".\nAnd thus when you call ",(0,t.jsx)(n.code,{children:"cancelAndJoin"})," on a ",(0,t.jsx)(n.code,{children:"CoroutineScope"})," it will properly await the ",(0,t.jsx)(n.code,{children:"finalizers"})," to have finished\nrunning."]}),"\n",(0,t.jsxs)(n.p,{children:["With SuspendApp this means that if someone sends a terminal signal such as ",(0,t.jsx)(n.code,{children:"SIGINT"})," or ",(0,t.jsx)(n.code,{children:"SIGTERM"})," to the application\nthen it will run all the ",(0,t.jsx)(n.em,{children:"suspend finalizers"})," before closing the application."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-kotlin",children:'fun main() = SuspendApp {\n  resourceScope {\n    install({ println("Creating some resource") }) { _, exitCase ->\n      println("ExitCase: $exitCase")\n      println("Shutting down will take 10 seconds")\n      delay(10_000)\n      println("Shutdown finished")\n    }\n    println("Application running with acquired resources.")\n    awaitCancellation()\n  }\n}\n'})}),"\n",(0,t.jsxs)(n.p,{children:["In the example above we have a ",(0,t.jsx)(n.code,{children:"Resource"})," that during ",(0,t.jsx)(n.em,{children:"acquisition"})," will print ",(0,t.jsx)(n.code,{children:"Creating some resource"}),",\nwhen the ",(0,t.jsx)(n.code,{children:"Resource"})," needs to be closed, ",(0,t.jsx)(n.em,{children:"release"}),", we print the ",(0,t.jsx)(n.code,{children:"ExitCase"})," with which the ",(0,t.jsx)(n.code,{children:"Resource"})," was closed, and\nthen we wait for 10 seconds. The ",(0,t.jsx)(n.code,{children:"Resource"})," already takes care of calling ",(0,t.jsx)(n.code,{children:"release"})," on a ",(0,t.jsx)(n.code,{children:"NonCancellable"})," context."]}),"\n",(0,t.jsxs)(n.p,{children:["We consume the ",(0,t.jsx)(n.code,{children:"Resource"})," until our application is cancelled by calling ",(0,t.jsx)(n.code,{children:"awaitCancellation"})," from KotlinX Coroutines.\nThat gives us the following output, if you press ",(0,t.jsx)(n.em,{children:"Ctrl+C"})," in the terminal."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-text",children:"Creating some resource\nApplication running with acquired resources.\n^CExitCase: Cancelled(exception=kotlinx.coroutines.JobCancellationException: LazyStandaloneCoroutine was cancelled; job=LazyStandaloneCoroutine{Cancelling}@f7470010)\nShutting down will take 10 seconds\nShutdown finished\n"})}),"\n",(0,t.jsx)(n.admonition,{type:"tip",children:(0,t.jsxs)(n.p,{children:["You can find this example in the ",(0,t.jsx)(n.a,{href:"https://github.com/arrow-kt/suspendapp/tree/main/example",children:"repository"}),", currently setup for NodeJS and native targets."]})}),"\n",(0,t.jsx)(n.h2,{id:"running-on-different-platforms",children:"Running on different platforms"}),"\n",(0,t.jsxs)(n.p,{children:["For more details on Kotlin Multiplatform configuration consult the ",(0,t.jsx)(n.a,{href:"https://kotlinlang.org/docs/multiplatform.html",children:"official documentation"}),".\nJust ",(0,t.jsx)(n.code,{children:"./gradlew build"})," the project, and launch the created binaries as shown in the sections belows."]}),"\n",(0,t.jsxs)(n.admonition,{title:"Currently supported targets",type:"note",children:[(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"JVM"}),"\n",(0,t.jsx)(n.li,{children:"MacOsX64 & MacosArm64"}),"\n",(0,t.jsx)(n.li,{children:"NodeJS"}),"\n",(0,t.jsx)(n.li,{children:"Windows (MingwX64)"}),"\n",(0,t.jsx)(n.li,{children:"Linux"}),"\n"]}),(0,t.jsxs)(n.p,{children:["SuspendApp currently does not support any mobile or browser targets because it does not make sense to have such\napplication behavior on such platforms. If you have a use-case for this please ",(0,t.jsx)(n.a,{href:"https://github.com/arrow-kt/suspendapp/issues",children:"open a ticket"}),"!"]})]}),"\n",(0,t.jsx)(n.h3,{id:"nodejs",children:"Node.js"}),"\n",(0,t.jsx)(n.p,{children:"Make sure you configure your NodeJS app to be executable."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"js(IR) {\n  nodejs {\n    binaries.executable()\n  }\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["You can run your NodeJS app with the following ",(0,t.jsx)(n.code,{children:"node"})," command,\nand if you press ",(0,t.jsx)(n.em,{children:"Ctrl+C"})," within the first 2500ms you will see the following output."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-text",children:"node build/js/packages/YourAppName/kotlin/YourAppName.js\n\nApp Started! Waiting until asked to shutdown.\n^CCleaning up App... will take 10 seconds...\nDone cleaning up. Will release app to exit\n"})}),"\n",(0,t.jsx)(n.h3,{id:"native",children:"Native"}),"\n",(0,t.jsx)(n.p,{children:"Make sure you configure your Native app(s) to be executable."}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"linuxX64 {\n  binaries.executable()\n}\nmingwX64 {\n  binaries.executable()\n}\nmacosArm64 {\n  binaries.executable()\n}\nmacosX64 {\n  binaries.executable()\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:["You can run your Native app with the following command,\nand if you press ",(0,t.jsx)(n.em,{children:"Ctrl+C"})," within the first 2500ms you will see the following output."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-text",children:"./gradlew build\nbuild/bin/native/releaseExecutable/YourAppName.kexe\n\nApp Started! Waiting until asked to shutdown.\n^CCleaning up App... will take 10 seconds...\nDone cleaning up. Will release app to exit\n"})})]})}function u(e={}){const{wrapper:n}={...(0,s.a)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},66569:(e,n,i)=>{i.d(n,{k:()=>h});i(67294);var t=i(33692),s=i(44996);const r="linkCard_uxt7",o="icon_lqTJ",l="cardHeader_NaDd",a="cardBody_svEQ",c="paragraph_UbEf";var d=i(85893);function u(e){let{href:n,children:i}=e;return(0,d.jsx)(t.Z,{href:n,className:r,children:i})}function p(e){let{title:n,icon:i,body:t}=e;return(0,d.jsxs)("div",{className:"card",children:[(0,d.jsxs)("div",{className:`card__header ${l}`,children:[(0,d.jsx)("img",{className:o,src:(0,s.Z)(`/img/${i}`),alt:`${n} category`,title:`${n} category`,width:"48px",height:"48px"}),(0,d.jsx)("h2",{title:n,className:"text--truncate",children:n})]}),(0,d.jsx)("div",{className:`card__body ${a}`,children:(0,d.jsx)("p",{className:`${c}`,children:t})})]})}const h=e=>(0,d.jsx)(u,{href:e.href,children:(0,d.jsx)(p,{...e})})},97048:(e,n,i)=>{i.d(n,{Z:()=>d});i(67294);var t=i(53438),s=i(66569),r=i(85893);const o="icon-tutorial.svg";function l(e){let{item:n}=e;const i=function(){try{return(0,t.jA)()}catch{return}}()?.customProps?.icon,l={title:n.label,icon:n.customProps?.icon||i||o,href:n.href,body:n.customProps?.description??("link"===n.type&&(0,t.xz)(n.docId??void 0)).description??void 0};return(0,r.jsx)(s.k,{...l})}const a={container:"container_Mg1N"};function c(e){let{className:n}=e;const i=(0,t.jA)();return(0,r.jsx)(d,{items:i.items,className:n})}function d(e){const{items:n,className:i}=e;if(!n)return(0,r.jsx)(c,{...e});const s=(0,t.MN)(n);return(0,r.jsx)("section",{className:`${a.container} ${i}`,children:s.map(((e,n)=>(0,r.jsx)("article",{children:(0,r.jsx)(l,{item:e})},n)))})}},11151:(e,n,i)=>{i.d(n,{Z:()=>l,a:()=>o});var t=i(67294);const s={},r=t.createContext(s);function o(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);