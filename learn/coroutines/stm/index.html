<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-learn/coroutines/stm" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.3.2">
<title data-rh="true">Transactional memory (STM) | Arrow</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://arrow-kt.io/img/social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://arrow-kt.io/img/social-card.jpg"><meta data-rh="true" property="og:url" content="https://arrow-kt.io/learn/coroutines/stm/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Transactional memory (STM) | Arrow"><meta data-rh="true" name="description" content="Software transactional memory, or STM, is an abstraction for concurrent state modification."><meta data-rh="true" property="og:description" content="Software transactional memory, or STM, is an abstraction for concurrent state modification."><link data-rh="true" rel="icon" href="/img/arrow-brand-icon.svg"><link data-rh="true" rel="canonical" href="https://arrow-kt.io/learn/coroutines/stm/"><link data-rh="true" rel="alternate" href="https://arrow-kt.io/learn/coroutines/stm/" hreflang="en"><link data-rh="true" rel="alternate" href="https://arrow-kt.io/learn/coroutines/stm/" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/community/blog/rss.xml" title="Arrow RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/community/blog/atom.xml" title="Arrow Atom Feed"><link rel="stylesheet" href="/assets/css/styles.95c53382.css">
<script src="/assets/js/runtime~main.e7dbf8af.js" defer="defer"></script>
<script src="/assets/js/main.4a883a3d.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/arrow-brand.svg" alt="Arrow Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/img/arrow-brand-dark.svg" alt="Arrow Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div></a></div><div class="navbar__items navbar__items--right"><a class="navbar__item navbar__link" href="/">Home</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" aria-haspopup="true" aria-expanded="false" role="button" href="/learn/overview/">Learn</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/learn/quickstart/">Quickstart</a></li><li><a class="dropdown__link" href="/learn/typed-errors/">Typed errors</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/learn/coroutines/">Concurrency and resources</a></li><li><a class="dropdown__link" href="/learn/resilience/">Resilience</a></li><li><a class="dropdown__link" href="/learn/immutable-data/">Immutable data</a></li><li><a class="dropdown__link" href="/learn/collections-functions/">Collections and functions</a></li><li><a class="dropdown__link" href="/learn/design/">Design recipes</a></li><li><a class="dropdown__link" href="/learn/projects/">Example projects</a></li><li><a class="dropdown__link" href="/learn/integrations/">Integrations</a></li></ul></div><a href="https://apidocs.arrow-kt.io" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">API Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Community</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/community/blog/">Blog</a></li><li><a class="dropdown__link" href="/libraries/">More libraries</a></li></ul></div><div class="navbar__item"><img src="https://img.shields.io/maven-central/v/io.arrow-kt/arrow-core?color=5b88f8&label=latest"></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="navbar__search searchBarContainer_NW3z"><input placeholder="Search" aria-label="Search" class="navbar__search-input"><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/learn/quickstart/">Quickstart</a><button aria-label="Expand sidebar category &#x27;Quickstart&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/learn/typed-errors/">Typed errors</a><button aria-label="Expand sidebar category &#x27;Typed errors&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" href="/learn/coroutines/">Concurrency and resources</a><button aria-label="Collapse sidebar category &#x27;Concurrency and resources&#x27;" aria-expanded="true" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/learn/coroutines/parallel/">Parallelism</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/learn/coroutines/racing/">Racing</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/learn/coroutines/resource-safety/">Resource</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" tabindex="0" href="/learn/coroutines/suspendapp/">Graceful shutdown</a><button aria-label="Expand sidebar category &#x27;Graceful shutdown&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/learn/coroutines/stm/">Transactional memory (STM)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/learn/coroutines/concurrency-primitives/">Concurrency primitives</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/learn/resilience/">Resilience</a><button aria-label="Expand sidebar category &#x27;Resilience&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/learn/immutable-data/">Immutable data</a><button aria-label="Expand sidebar category &#x27;Immutable data&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/learn/collections-functions/">Collections and functions</a><button aria-label="Expand sidebar category &#x27;Collections and functions&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" href="/learn/design/">Design recipes</a><button aria-label="Expand sidebar category &#x27;Design recipes&#x27;" aria-expanded="false" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/learn/projects/">Example projects</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/learn/integrations/">Integrations</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/learn/summary/">Summary</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item sidebar-hidden"><a class="menu__link" href="/learn/overview/">overview</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Transactional memory (STM)</h1>
<p>Software transactional memory, or STM, is an abstraction for concurrent state modification.
With STM, one can write code that concurrently accesses state, and that can easily be composed without
exposing details of how it ensures safety guarantees.
Programs running within an STM transaction will neither deadlock nor have race-conditions.
The base building blocks of STM are <code>TVar</code>s and the primitives <code>retry</code>, <code>orElse</code>, and <code>catch</code>.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M12 23c6.075 0 11-4.925 11-11S18.075 1 12 1 1 5.925 1 12s4.925 11 11 11M9 11.5h2v4H9v2h6v-2h-2v-6H9zM13 8V6h-2v2z" clip-rule="evenodd"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>The API of <code>arrow-fx-stm</code> is based on Haskell&#x27;s <a href="https://hackage.haskell.org/package/stm" target="_blank" rel="noopener noreferrer"><code>stm</code></a> package, and the implementation is based on the GHC implementation for fine-grained locks.
For further information, you can read <a href="https://www.microsoft.com/en-us/research/publication/composable-memory-transactions/" target="_blank" rel="noopener noreferrer"><em>Composable memory transactions</em></a> by Tim Harris, Simon Marlow, Simon Peyton Jones, and Maurice Herlihy.</p></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M1 12c0 6.075 4.925 11 11 11s11-4.925 11-11S18.075 1 12 1 1 5.925 1 12m8.793-4.293L14.086 12l-4.293 4.293 1.414 1.414 5-5 .707-.707-.707-.707-5-5z" clip-rule="evenodd"></path></svg></span>Where to find it</div><div class="admonitionContent_BuS1"><p>Software Transaction Memory is available in the <code>arrow-fx-stm</code> library.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="reading-and-writing-concurrent-state">Reading and writing concurrent state<a href="#reading-and-writing-concurrent-state" class="hash-link" aria-label="Direct link to Reading and writing concurrent state" title="Direct link to Reading and writing concurrent state">​</a></h2>
<p>Those values that live under the umbrella of STM must be defined as <code>TVar</code>s
(short for <em>transactional variable</em>).
You can think of a <a href="https://apidocs.arrow-kt.io/arrow-fx-stm/arrow.fx.stm/-t-var/index.html" target="_blank" rel="noopener noreferrer"><code>TVar&lt;A&gt;</code></a> as a variable holding values of type <code>A</code>, but where
concurrent modification is protected.
<code>TVar</code>s are not the only transactional data structure (more on that later),
but in any case, to modify one, you need to be <em>inside</em> the
STM context. This is achieved either by defining our
functions with <code>STM</code> as the receiver, or using <code>stm</code> to create lambda functions
with such a receiver.</p>
<p>By itself, a function using <code>STM</code> as a receiver does <em>not</em> perform any computations.
We say it&#x27;s just a <em>description</em> of a transaction. Running a transaction is then
done using <a href="https://apidocs.arrow-kt.io/arrow-fx-stm/arrow.fx.stm/atomically.html" target="_blank" rel="noopener noreferrer"><code>atomically</code></a>.</p>
<p>The example below shows a banking service moving money from one account to another with STM.
Should the first account not have enough money, we throw an exception. This code is guaranteed never to deadlock and to never
produce an invalid state by committing after the read state has changed concurrently.</p>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#222E51"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style="color:#D4D4D4;background-color:#222E51"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token keyword" style="color:#82a2f3">import</span><span class="token plain"> arrow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">fx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">stm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">atomically</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#82a2f3">import</span><span class="token plain"> arrow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">fx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">stm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">TVar</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#82a2f3">import</span><span class="token plain"> arrow</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">fx</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">stm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">STM</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#82a2f3">fun</span><span class="token plain"> STM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">transfer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">from</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> TVar</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">Int</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:#82a2f3">to</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> TVar</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">Int</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> amount</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token function" style="color:#EDB368">withdraw</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">from</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> amount</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token function" style="color:#EDB368">deposit</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:#82a2f3">to</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> amount</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#82a2f3">fun</span><span class="token plain"> STM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">deposit</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">acc</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> TVar</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">Int</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> amount</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token keyword" style="color:#82a2f3">val</span><span class="token plain"> current </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> acc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">read</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  acc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">write</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">current </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> amount</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token comment" style="color:#6b738a">// or the shorthand acc.modify { it + amount }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#82a2f3">fun</span><span class="token plain"> STM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">withdraw</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">acc</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> TVar</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">Int</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> amount</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token keyword" style="color:#82a2f3">val</span><span class="token plain"> current </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> acc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">read</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token function" style="color:#EDB368">require</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">current </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> amount </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#cfcd9a">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> </span><span class="token string-literal singleline string" style="color:#5B88F8">&quot;Not enough money in the account!&quot;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  acc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">write</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">current </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> amount</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#82a2f3">suspend</span><span class="token plain"> </span><span class="token keyword" style="color:#82a2f3">fun</span><span class="token plain"> </span><span class="token function" style="color:#EDB368">example</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token keyword" style="color:#82a2f3">val</span><span class="token plain"> acc1 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> TVar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">new</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:#cfcd9a">500</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token keyword" style="color:#82a2f3">val</span><span class="token plain"> acc2 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> TVar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">new</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:#cfcd9a">300</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token comment" style="color:#6b738a">// check initial balances</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  acc1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">unsafeRead</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> shouldBe </span><span class="token number" style="color:#cfcd9a">500</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  acc2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">unsafeRead</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> shouldBe </span><span class="token number" style="color:#cfcd9a">300</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token comment" style="color:#6b738a">// perform transaction</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  atomically </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> </span><span class="token function" style="color:#EDB368">transfer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">acc1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> acc2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:#cfcd9a">50</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token comment" style="color:#6b738a">// check final balances</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  acc1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">unsafeRead</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> shouldBe </span><span class="token number" style="color:#cfcd9a">450</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  acc2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">unsafeRead</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> shouldBe </span><span class="token number" style="color:#cfcd9a">350</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>One additional guarantee of STM is that the <em>whole</em> transaction is executed
atomically. That means we can modify several <code>TVar</code>s in one transaction,
and we&#x27;ll never observe an intermediate state.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.25 9a7.75 7.75 0 1 1 15.5 0v4.823l2.464 4.927H1.787l2.463-4.927zM10 23h4v-2h-4z" clip-rule="evenodd"></path></svg></span>Delegated transactional properties</div><div class="admonitionContent_BuS1"><p>Starting from version 2.0, you can use <a href="https://kotlinlang.org/docs/delegated-properties.html" target="_blank" rel="noopener noreferrer">property delegation</a>
to access a <code>TVar</code>. That way you don&#x27;t need explicit <code>read</code> or <code>write</code>,
they become implicit in the syntax.</p><div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#222E51"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style="color:#D4D4D4;background-color:#222E51"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token keyword" style="color:#82a2f3">fun</span><span class="token plain"> STM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">deposit</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">accVar</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> TVar</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">Int</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> amount</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token keyword" style="color:#82a2f3">var</span><span class="token plain"> acc </span><span class="token keyword" style="color:#82a2f3">by</span><span class="token plain"> accVar       </span><span class="token comment" style="color:#6b738a">// property delegation</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token keyword" style="color:#82a2f3">val</span><span class="token plain"> current </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> acc       </span><span class="token comment" style="color:#6b738a">// implicit &#x27;read&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  acc </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> current </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> amount  </span><span class="token comment" style="color:#6b738a">// implicit &#x27;write&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token comment" style="color:#6b738a">// or simply, acc = acc + amount</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="other-stm-data-structures">Other STM data structures<a href="#other-stm-data-structures" class="hash-link" aria-label="Direct link to Other STM data structures" title="Direct link to Other STM data structures">​</a></h3>
<p>The following types are built upon <code>TVar</code>s and provided out of the box with Arrow:</p>
<ul>
<li><a href="https://apidocs.arrow-kt.io/arrow-fx-stm/arrow.fx.stm/-t-queue/index.html" target="_blank" rel="noopener noreferrer"><code>TQueue</code></a>: transactional mutable queue</li>
<li><a href="https://apidocs.arrow-kt.io/arrow-fx-stm/arrow.fx.stm/-t-m-var/index.html" target="_blank" rel="noopener noreferrer"><code>TMVar</code></a>: mutable transactional variable that may be empty</li>
<li><a href="https://apidocs.arrow-kt.io/arrow-fx-stm/arrow.fx.stm/-t-set/index.html" target="_blank" rel="noopener noreferrer"><code>TSet</code></a>, <a href="https://apidocs.arrow-kt.io/arrow-fx-stm/arrow.fx.stm/-t-map/index.html" target="_blank" rel="noopener noreferrer"><code>TMap</code></a>: transactional <code>Set</code> and <code>Map</code></li>
<li><a href="https://apidocs.arrow-kt.io/arrow-fx-stm/arrow.fx.stm/-t-array/index.html" target="_blank" rel="noopener noreferrer"><code>TArray</code></a>: array of <code>TVar</code>s</li>
<li><a href="https://apidocs.arrow-kt.io/arrow-fx-stm/arrow.fx.stm/-t-semaphore/index.html" target="_blank" rel="noopener noreferrer"><code>TSemaphore</code></a>: transactional semaphore</li>
</ul>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M4.25 9a7.75 7.75 0 1 1 15.5 0v4.823l2.464 4.927H1.787l2.463-4.927zM10 23h4v-2h-4z" clip-rule="evenodd"></path></svg></span>tip</div><div class="admonitionContent_BuS1"><p>Note that, in most cases, using these data structures is much more efficient than
wrapping their &quot;regular&quot; version in a <code>TVar</code>. For example, a <code>TSet&lt;A&gt;</code> performs
better than a <code>TVar&lt;Set&lt;A&gt;&gt;</code> because the latter needs to &quot;lock&quot; the entire set
on modification, whereas the former knows that only the affected entries need
to be taken into account.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="retries">Retries<a href="#retries" class="hash-link" aria-label="Direct link to Retries" title="Direct link to Retries">​</a></h2>
<p>It is sometimes beneficial to manually abort the current transaction if an
invalid state has been reached. For example, a <code>TQueue</code> had no elements to read.
The aborted transaction will automatically restart once any previously accessed
variable has changed.</p>
<p>Here in this example, we&#x27;ve changed <code>withdraw</code> to use <code>retry</code> and thus wait until
enough money is in the account, which after a few seconds happens to be the case.</p>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#222E51"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style="color:#D4D4D4;background-color:#222E51"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token keyword" style="color:#82a2f3">fun</span><span class="token plain"> STM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">transfer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">from</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> TVar</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">Int</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:#82a2f3">to</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> TVar</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">Int</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> amount</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token function" style="color:#EDB368">withdraw</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">from</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> amount</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token function" style="color:#EDB368">deposit</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:#82a2f3">to</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> amount</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#82a2f3">fun</span><span class="token plain"> STM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">deposit</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">acc</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> TVar</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">Int</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> amount</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token keyword" style="color:#82a2f3">val</span><span class="token plain"> current </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> acc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">read</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  acc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">write</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">current </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> amount</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token comment" style="color:#6b738a">// or the shorthand acc.modify { it + amount }</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#82a2f3">fun</span><span class="token plain"> STM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">withdraw</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">acc</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> TVar</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">Int</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> amount</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Int</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token keyword" style="color:#82a2f3">val</span><span class="token plain"> current </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> acc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">read</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token keyword" style="color:#82a2f3">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">current </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> amount </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;=</span><span class="token plain"> </span><span class="token number" style="color:#cfcd9a">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> acc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">write</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">current </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> amount</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token keyword" style="color:#82a2f3">else</span><span class="token plain"> </span><span class="token function" style="color:#EDB368">retry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token comment" style="color:#6b738a">// the two lines above could also be written as</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token comment" style="color:#6b738a">// check(current - amount &gt;= 0)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token comment" style="color:#6b738a">// acc.write(it - amount)`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#82a2f3">suspend</span><span class="token plain"> </span><span class="token keyword" style="color:#82a2f3">fun</span><span class="token plain"> </span><span class="token function" style="color:#EDB368">example</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> coroutineScope </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token keyword" style="color:#82a2f3">val</span><span class="token plain"> acc1 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> TVar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">new</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:#cfcd9a">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token keyword" style="color:#82a2f3">val</span><span class="token plain"> acc2 </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> TVar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">new</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:#cfcd9a">300</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token comment" style="color:#6b738a">// check initial balances</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  acc1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">unsafeRead</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> shouldBe </span><span class="token number" style="color:#cfcd9a">0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  acc2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">unsafeRead</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> shouldBe </span><span class="token number" style="color:#cfcd9a">300</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token comment" style="color:#6b738a">// simulate some wait time until the money is available</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  async </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token function" style="color:#EDB368">delay</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:#cfcd9a">500</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    atomically </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> acc1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">write</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:#cfcd9a">100_000_000</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token comment" style="color:#6b738a">// concurrently attempt the transaction</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  atomically </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token function" style="color:#EDB368">transfer</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">acc1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> acc2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:#cfcd9a">50</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token comment" style="color:#6b738a">// check final balances</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  acc1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">unsafeRead</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token function" style="color:#EDB368">shouldBe</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:#cfcd9a">100_000_000</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token number" style="color:#cfcd9a">50</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  acc2</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">unsafeRead</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> shouldBe </span><span class="token number" style="color:#cfcd9a">350</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><code>retry</code> can be used to implement a lot of complex transactions,
and lies at the heart of the implementation of more complex transactional
data structured like <code>TMVar</code> and <code>TQueue</code>.</p>
<div class="theme-admonition theme-admonition-caution admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="m12 1.5-11 21h22zM11 16v-6h2v6zm0 2v2h2v-2z" clip-rule="evenodd"></path></svg></span>caution</div><div class="admonitionContent_BuS1"><p>A transaction that sees an invalid state (which includes reading a <code>TVar</code> that has been changed concurrently) will restart and try again.
This usually means we rerun the function entirely. Therefore it is recommended to keep transactions small and never to use code that
has side effects inside.</p><ul>
<li>Transactions may be aborted at any time, so accessing resources may never trigger finalizers</li>
<li>Transactions may rerun an arbitrary number of times before finishing, and thus all effects will rerun</li>
</ul></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="branching">Branching<a href="#branching" class="hash-link" aria-label="Direct link to Branching" title="Direct link to Branching">​</a></h3>
<p>The counterpart to <code>retry</code> is <code>orElse</code>, which allows detecting whether a branch
has called <a href="https://apidocs.arrow-kt.io/arrow-fx-stm/arrow.fx.stm/-s-t-m/retry.html" target="_blank" rel="noopener noreferrer">retry</a> and then use a fallback instead. If the fallback retries as
well, then the whole transaction retries.</p>
<p>In the example below, we use <code>orElse</code> to return <code>null</code> whenever the <code>check</code>
fails. By default, <code>check</code> retries the transaction, hence the need for <code>orElse</code>.</p>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#D4D4D4;--prism-background-color:#222E51"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style="color:#D4D4D4;background-color:#222E51"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#D4D4D4"><span class="token keyword" style="color:#82a2f3">fun</span><span class="token plain"> STM</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">transaction</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">v</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> TVar</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">Int</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Int</span><span class="token operator" style="color:rgb(212, 212, 212)">?</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  stm </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token keyword" style="color:#82a2f3">val</span><span class="token plain"> result </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">read</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    </span><span class="token function" style="color:#EDB368">check</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">result </span><span class="token keyword" style="color:#82a2f3">in</span><span class="token plain"> </span><span class="token number" style="color:#cfcd9a">0</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">..</span><span class="token plain"> </span><span class="token number" style="color:#cfcd9a">10</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">    result</span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> orElse </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> </span><span class="token keyword" style="color:#82a2f3">null</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token keyword" style="color:#82a2f3">suspend</span><span class="token plain"> </span><span class="token keyword" style="color:#82a2f3">fun</span><span class="token plain"> </span><span class="token function" style="color:#EDB368">example</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token keyword" style="color:#82a2f3">val</span><span class="token plain"> v </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> TVar</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">new</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:#cfcd9a">100</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token comment" style="color:#6b738a">// check initial balance</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">unsafeRead</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> shouldBe </span><span class="token number" style="color:#cfcd9a">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token comment" style="color:#6b738a">// value is outside the range, should fail</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  atomically </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> </span><span class="token function" style="color:#EDB368">transaction</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> shouldBe </span><span class="token keyword" style="color:#82a2f3">null</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  atomically </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style="color:#EDB368">write</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token number" style="color:#cfcd9a">5</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  </span><span class="token comment" style="color:#6b738a">// value now is inside the range, should succeed</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain">  atomically </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> </span><span class="token function" style="color:#EDB368">transaction</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">v</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> shouldBe </span><span class="token number" style="color:#cfcd9a">5</span><span class="token plain"></span><br></span><span class="token-line" style="color:#D4D4D4"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="exceptions">Exceptions<a href="#exceptions" class="hash-link" aria-label="Direct link to Exceptions" title="Direct link to Exceptions">​</a></h2>
<p>Throwing inside STM will let the exception bubble up to either a <code>catch</code> handler
or to <code>atomically</code>, which will rethrow it. Note that this <code>catch</code> does <strong>not</strong> refer
to the built-in exception one, but rather to the function of the same name in
the STM module.</p>
<div class="theme-admonition theme-admonition-danger admonition_xJq3 alert alert--danger"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path fill="currentColor" fill-rule="evenodd" d="M23 12c0 6.075-4.925 11-11 11S1 18.075 1 12 5.925 1 12 1s11 4.925 11 11m-12 1V7h2v6zm0 2v2h2v-2z" clip-rule="evenodd"></path></svg></span>danger</div><div class="admonitionContent_BuS1"><p>Using <code>try {...} catch (e: Exception) {...}</code> is not encouraged because any state change inside <code>try</code> will not be undone when
an exception occurs. The recommended way of catching exceptions is to use the <code>catch</code> function, which properly rolls back the transaction.</p></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/arrow-kt/arrow-website/edit/main/content/docs/learn/coroutines/stm.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/learn/coroutines/suspendapp/kafka/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">... with Kafka</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/learn/coroutines/concurrency-primitives/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Concurrency primitives</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#reading-and-writing-concurrent-state" class="table-of-contents__link toc-highlight">Reading and writing concurrent state</a><ul><li><a href="#other-stm-data-structures" class="table-of-contents__link toc-highlight">Other STM data structures</a></li></ul></li><li><a href="#retries" class="table-of-contents__link toc-highlight">Retries</a><ul><li><a href="#branching" class="table-of-contents__link toc-highlight">Branching</a></li></ul></li><li><a href="#exceptions" class="table-of-contents__link toc-highlight">Exceptions</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer"><div class="container container-fluid container_y1z5"><div><div class="margin-bottom--sm logo_cbK_"><a href="https://arrow-kt.io" rel="noopener noreferrer" class="footerLogoLink_BH7S"><img src="/img/arrow-brand.svg" alt="Arrow Logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE" width="128" height="42"><img src="/img/arrow-brand-dark.svg" alt="Arrow Logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU" width="128" height="42"></a></div><small><div class="footer__copyright">Arrow is developed and maintained by the community</div></small></div><div class="row footer__links"><div class="col footer__col"><div class="footer__title"></div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://apidocs.arrow-kt.io" target="_blank" rel="noopener noreferrer" class="footer__link-item">API Docs<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/community/blog/">Blog</a></li><li class="footer__item"><a class="footer__link-item" href="/learn/projects/">Example projects</a></li></ul></div><div class="col footer__col"><div class="footer__title">Learn</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/learn/quickstart/">Quickstart</a></li><li class="footer__item"><a class="footer__link-item" href="/learn/typed-errors/">Typed errors</a></li><li class="footer__item"><a class="footer__link-item" href="/learn/coroutines/">Coroutines</a></li><li class="footer__item"><a class="footer__link-item" href="/learn/resilience/">Resilience</a></li></ul></div><div class="col footer__col"><div class="footer__title">...</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/learn/immutable-data/">Immutable data</a></li><li class="footer__item"><a class="footer__link-item" href="/learn/collections-functions/">Collections and functions</a></li><li class="footer__item"><a class="footer__link-item" href="/learn/design/">Design</a></li><li class="footer__item"><a class="footer__link-item" href="/learn/integrations/">Integrations</a></li></ul></div></div><ul class="clean-list container_dM9r"><li><a href="https://twitter.com/arrow_kt" target="_blank" rel="noopener noreferrer"><img src="/img/icon-social-twitter.svg" alt="Twitter" title="Twitter" height="24px" width="24px"></a></li><li><a href="https://slack-chats.kotlinlang.org/c/arrow" target="_blank" rel="noopener noreferrer"><img src="/img/icon-social-slack.svg" alt="Slack" title="Slack" height="24px" width="24px"></a></li><li><a href="https://github.com/arrow-kt" target="_blank" rel="noopener noreferrer"><img src="/img/icon-social-github.svg" alt="GitHub" title="GitHub" height="24px" width="24px"></a></li><li><a href="https://stackoverflow.com/questions/tagged/arrow-kt" target="_blank" rel="noopener noreferrer"><img src="/img/icon-social-stackoverflow.svg" alt="Stack Overflow" title="Stack Overflow" height="24px" width="24px"></a></li><div class="starsContainer_WEfU"><div>Loading...</div></div></ul></div></footer></div>
</body>
</html>