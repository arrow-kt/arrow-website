<!doctype html><html lang=en dir=ltr class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-learn/coroutines/resource-safety" data-has-hydrated=false><head><meta charset=UTF-8><meta name=generator content="Docusaurus v3.9.2"><title data-rh=true>Resource | Arrow</title><meta data-rh=true name=viewport content="width=device-width, initial-scale=1.0"/><meta data-rh=true name=twitter:card content=summary_large_image /><meta data-rh=true property=og:image content=https://arrow-kt.io/img/social-card.jpg /><meta data-rh=true name=twitter:image content=https://arrow-kt.io/img/social-card.jpg /><meta data-rh=true property=og:url content=https://arrow-kt.io/learn/coroutines/resource-safety/ /><meta data-rh=true property=og:locale content=en /><meta data-rh=true name=docusaurus_locale content=en /><meta data-rh=true name=docsearch:language content=en /><meta data-rh=true name=docusaurus_version content=current /><meta data-rh=true name=docusaurus_tag content=docs-default-current /><meta data-rh=true name=docsearch:version content=current /><meta data-rh=true name=docsearch:docusaurus_tag content=docs-default-current /><meta data-rh=true property=og:title content="Resource | Arrow"/><meta data-rh=true name=description content="Allocation and release of resources is not easy, especially when"/><meta data-rh=true property=og:description content="Allocation and release of resources is not easy, especially when"/><link data-rh=true rel=icon href=/img/arrow-brand-icon.svg /><link data-rh=true rel=canonical href=https://arrow-kt.io/learn/coroutines/resource-safety/ /><link data-rh=true rel=alternate href=https://arrow-kt.io/learn/coroutines/resource-safety/ hreflang=en /><link data-rh=true rel=alternate href=https://arrow-kt.io/learn/coroutines/resource-safety/ hreflang=x-default /><link rel=alternate type=application/rss+xml href=/community/blog/rss.xml title="Arrow RSS Feed"><link rel=alternate type=application/atom+xml href=/community/blog/atom.xml title="Arrow Atom Feed"><link rel=stylesheet href=/assets/css/styles.8bb0fd9c.css /><script src=/assets/js/runtime~main.9536f532.js defer></script><script src=/assets/js/main.708a032c.js defer></script></head><body class=navigation-with-keyboard><svg style="display: none;"><defs>
<symbol id=theme-svg-external-link viewBox="0 0 24 24"><path fill=currentColor d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{for(var[t,e]of new URLSearchParams(window.location.search).entries())if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id=__docusaurus><div role=region aria-label="Skip to main content"><a class=skipToContent_fXgn href=#__docusaurus_skipToContent_fallback>Skip to main content</a></div><nav aria-label=Main class="theme-layout-navbar navbar navbar--fixed-top"><div class=navbar__inner><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded=false class="navbar__toggle clean-btn" type=button><svg width=30 height=30 viewBox="0 0 30 30" aria-hidden=true><path stroke=currentColor stroke-linecap=round stroke-miterlimit=10 stroke-width=2 d="M4 7h22M4 15h22M4 23h22"/></svg></button><a class=navbar__brand href=/><div class=navbar__logo><img src=/img/arrow-brand.svg alt="Arrow Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"/><img src=/img/arrow-brand-dark.svg alt="Arrow Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"/></div></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a class="navbar__item navbar__link" href=/>Home</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class=navbar__link aria-haspopup=true aria-expanded=false role=button href=/learn/overview/>Learn</a><ul class=dropdown__menu><li><a class=dropdown__link href=/learn/quickstart/>Quickstart</a><li><a class=dropdown__link href=/learn/typed-errors/>Typed errors</a><li><a aria-current=page class="dropdown__link dropdown__link--active" href=/learn/coroutines/>Concurrency and resources</a><li><a class=dropdown__link href=/learn/resilience/>Resilience</a><li><a class=dropdown__link href=/learn/immutable-data/>Immutable data</a><li><a class=dropdown__link href=/learn/collections-functions/>Collections and functions</a><li><a class=dropdown__link href=/learn/design/>Design recipes</a><li><a class=dropdown__link href=/learn/projects/>Example projects</a><li><a class=dropdown__link href=/learn/integrations/>Integrations</a></ul></div><a href=https://apidocs.arrow-kt.io target=_blank rel="noopener noreferrer" class="navbar__item navbar__link">API Docs<svg width=13.5 height=13.5 aria-label="(opens in new tab)" class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href=# aria-haspopup=true aria-expanded=false role=button class=navbar__link>Community</a><ul class=dropdown__menu><li><a class=dropdown__link href=/community/blog/>Blog</a><li><a class=dropdown__link href=/libraries/>More libraries</a></ul></div><div class=navbar__item><img src="https://img.shields.io/maven-central/v/io.arrow-kt/arrow-core?color=5b88f8&label=latest"></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type=button disabled title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill=currentColor d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill=currentColor d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"/></svg><svg viewBox="0 0 24 24" width=24 height=24 aria-hidden=true class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill=currentColor d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"/></svg></button></div><div class=navbarSearchContainer_Bca1><div class="navbar__search searchBarContainer_NW3z" dir=ltr><input placeholder=Search aria-label=Search class="navbar__search-input searchInput_YFbd" value="" /><div class="loadingRing_RJI3 searchBarLoadingRing_YnHq"><div></div><div></div><div></div><div></div></div></div></div></div></div><div role=presentation class=navbar-sidebar__backdrop></div></nav><div id=__docusaurus_skipToContent_fallback class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class=docsWrapper_hBAB><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type=button></button><div class=docRoot_UBD9><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class=sidebarViewport_aRkj><div class=sidebar_njMd><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="categoryLink_byQd menu__link menu__link--sublist" href=/learn/quickstart/><span title=Quickstart class=categoryLinkLabel_W154>Quickstart</span></a><button aria-label="Expand sidebar category 'Quickstart'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="categoryLink_byQd menu__link menu__link--sublist" href=/learn/typed-errors/><span title="Typed errors" class=categoryLinkLabel_W154>Typed errors</span></a><button aria-label="Expand sidebar category 'Typed errors'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class=menu__list-item-collapsible><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--active" href=/learn/coroutines/><span title="Concurrency and resources" class=categoryLinkLabel_W154>Concurrency and resources</span></a><button aria-label="Collapse sidebar category 'Concurrency and resources'" aria-expanded=true type=button class="clean-btn menu__caret"></button></div><ul class=menu__list><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/learn/coroutines/parallel/><span title=Parallelism class=linkLabel_WmDU>Parallelism</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/learn/coroutines/racing/><span title=Racing class=linkLabel_WmDU>Racing</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current=page tabindex=0 href=/learn/coroutines/resource-safety/><span title=Resource class=linkLabel_WmDU>Resource</span></a><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="categoryLink_byQd menu__link menu__link--sublist" tabindex=0 href=/learn/coroutines/suspendapp/><span title="Graceful shutdown" class=categoryLinkLabel_W154>Graceful shutdown</span></a><button aria-label="Expand sidebar category 'Graceful shutdown'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/learn/coroutines/stm/><span title="Transactional memory (STM)" class=linkLabel_WmDU>Transactional memory (STM)</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class=menu__link tabindex=0 href=/learn/coroutines/concurrency-primitives/><span title="Concurrency primitives" class=linkLabel_WmDU>Concurrency primitives</span></a></ul><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="categoryLink_byQd menu__link menu__link--sublist" href=/learn/resilience/><span title=Resilience class=categoryLinkLabel_W154>Resilience</span></a><button aria-label="Expand sidebar category 'Resilience'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="categoryLink_byQd menu__link menu__link--sublist" href=/learn/immutable-data/><span title="Immutable data" class=categoryLinkLabel_W154>Immutable data</span></a><button aria-label="Expand sidebar category 'Immutable data'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="categoryLink_byQd menu__link menu__link--sublist" href=/learn/collections-functions/><span title="Collections and functions" class=categoryLinkLabel_W154>Collections and functions</span></a><button aria-label="Expand sidebar category 'Collections and functions'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class=menu__list-item-collapsible><a class="categoryLink_byQd menu__link menu__link--sublist" href=/learn/design/><span title="Design recipes" class=categoryLinkLabel_W154>Design recipes</span></a><button aria-label="Expand sidebar category 'Design recipes'" aria-expanded=false type=button class="clean-btn menu__caret"></button></div><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/learn/projects/><span title="Example projects" class=linkLabel_WmDU>Example projects</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/learn/integrations/><span title=Integrations class=linkLabel_WmDU>Integrations</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class=menu__link href=/learn/summary/><span title=Summary class=linkLabel_WmDU>Summary</span></a><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item sidebar-hidden"><a class=menu__link href=/learn/overview/><span title=overview class=linkLabel_WmDU>overview</span></a></ul></nav></div></div></aside><main class=docMainContainer_TBSr><div class="container padding-top--md padding-bottom--lg"><div class=row><div class="col docItemCol_VOVn"><div class=docItemContainer_Djhp><article><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type=button class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Resource</h1></header>
<p>Allocation and release of resources is not easy, especially when
we have multiple resources that depend on each other. The Resource DSL
adds the ability to <em>install</em> resources and ensure proper finalization even
in the face of exceptions and cancellations. Arrow's Resource co-operate
with Structured Concurrency and KotlinX Coroutines.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg xmlns=http://www.w3.org/2000/svg width=24 height=24 fill=none viewBox="0 0 24 24"><path fill=currentColor fill-rule=evenodd d="M12 23c6.075 0 11-4.925 11-11S18.075 1 12 1 1 5.925 1 12s4.925 11 11 11M9 11.5h2v4H9v2h6v-2h-2v-6H9zM13 8V6h-2v2z" clip-rule=evenodd /></svg></span>Media resources</div><div class=admonitionContent_BuS1><ul>
<li class=""><a href="https://www.youtube.com/watch?v=zKrTBH8jqH4" target=_blank rel="noopener noreferrer" class=""><em>Graceful Resource Handling</em></a> by Simon Vergauwen</li>
<li class=""><a href=https://kotlindevday.com/videos/grateful-shutdown-with-structured-concurrency-simon-vergauwen/ target=_blank rel="noopener noreferrer" class=""><em>Graceful Shutdown with Structured Concurrency</em></a> by Simon Vergauwen</li>
</ul></div></div>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg xmlns=http://www.w3.org/2000/svg width=24 height=24 fill=none viewBox="0 0 24 24"><path fill=currentColor fill-rule=evenodd d="M1 12c0 6.075 4.925 11 11 11s11-4.925 11-11S18.075 1 12 1 1 5.925 1 12m8.793-4.293L14.086 12l-4.293 4.293 1.414 1.414 5-5 .707-.707-.707-.707-5-5z" clip-rule=evenodd /></svg></span>Where to find it</div><div class=admonitionContent_BuS1><p>Resource management is part of the <code>arrow-fx-coroutines</code> library. The separate <code>arrow-autoclose</code> library provides a similar API but without integration with Kotlin's coroutine mechanism.</div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=understanding-the-problem>Understanding the problem<a href=#understanding-the-problem class=hash-link aria-label="Direct link to Understanding the problem" title="Direct link to Understanding the problem" translate=no>​</a></h2>
<p>The following program is <strong>not</strong> safe because it is prone to leak <code>dataSource</code>
and <code>userProcessor</code> when an exception or cancellation signal occurs while using the service.</p>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#D4D4D4;--prism-background-color:#222E51><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style=color:#D4D4D4;background-color:#222E51><code class=codeBlockLines_e6Vv><span class=token-line style=color:#D4D4D4><span class="token keyword" style=color:#82a2f3>class</span><span class="token plain"> UserProcessor </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token keyword" style=color:#82a2f3>fun</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>start</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Unit </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>println</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal singleline string" style=color:#5B88F8>"Creating UserProcessor"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token keyword" style=color:#82a2f3>fun</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>shutdown</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Unit </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>println</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal singleline string" style=color:#5B88F8>"Shutting down UserProcessor"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain"></span><span class="token keyword" style=color:#82a2f3>class</span><span class="token plain"> DataSource </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token keyword" style=color:#82a2f3>fun</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>connect</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Unit </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>println</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal singleline string" style=color:#5B88F8>"Connecting dataSource"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token keyword" style=color:#82a2f3>fun</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>close</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Unit </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>println</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal singleline string" style=color:#5B88F8>"Closed dataSource"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain"></span><span class="token keyword" style=color:#82a2f3>class</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>Service</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style=color:#82a2f3>val</span><span class="token plain"> db</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> DataSource</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style=color:#82a2f3>val</span><span class="token plain"> userProcessor</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> UserProcessor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token keyword" style=color:#82a2f3>suspend</span><span class="token plain"> </span><span class="token keyword" style=color:#82a2f3>fun</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>processData</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> List</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">String</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">    </span><span class="token keyword" style=color:#82a2f3>throw</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>RuntimeException</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal singleline string" style=color:#5B88F8>"I'm going to leak resources by not closing them"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br/></span></code></pre></div></div>
<p>For example, the following application would leak resources.</p>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#D4D4D4;--prism-background-color:#222E51><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style=color:#D4D4D4;background-color:#222E51><code class=codeBlockLines_e6Vv><span class=token-line style=color:#D4D4D4><span class="token keyword" style=color:#82a2f3>suspend</span><span class="token plain"> </span><span class="token keyword" style=color:#82a2f3>fun</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>example</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token keyword" style=color:#82a2f3>val</span><span class="token plain"> userProcessor </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>UserProcessor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>also</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> it</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>start</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token keyword" style=color:#82a2f3>val</span><span class="token plain"> dataSource </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>DataSource</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>also</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> it</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>connect</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token keyword" style=color:#82a2f3>val</span><span class="token plain"> service </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>Service</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">dataSource</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> userProcessor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  service</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>processData</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  dataSource</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>close</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  userProcessor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>shutdown</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br/></span></code></pre></div></div>
<p>If we were using Kotlin JVM, we might rely on <code>Closeable</code> or <code>AutoCloseable</code> and rewrite our code like this.</p>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#D4D4D4;--prism-background-color:#222E51><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style=color:#D4D4D4;background-color:#222E51><code class=codeBlockLines_e6Vv><span class=token-line style=color:#D4D4D4><span class="token keyword" style=color:#82a2f3>suspend</span><span class="token plain"> </span><span class="token keyword" style=color:#82a2f3>fun</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>example</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token function" style=color:#EDB368>UserProcessor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>use</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> userProcessor </span><span class="token operator" style="color:rgb(212, 212, 212)">-></span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">    userProcessor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>start</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">    </span><span class="token function" style=color:#EDB368>DataSource</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>use</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> dataSource </span><span class="token operator" style="color:rgb(212, 212, 212)">-></span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">      dataSource</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>connect</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">      </span><span class="token function" style=color:#EDB368>Service</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">dataSource</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> userProcessor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>processData</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br/></span></code></pre></div></div>
<p>However, while we fixed the closing of <code>UserProcessor</code> and <code>DataSource</code>, there are still issues with this code:</p>
<ol>
<li class="">It requires implementing <code>Closeable</code> or <code>AutoCloseable</code>, which is only possible for Kotlin JVM but not available for Multiplatform.</li>
<li class="">Requires implementing an interface or wrapping external types with something like <code>class CloseableOf&lt;A>(val type: A): Closeable</code>.</li>
<li class="">Requires nesting of different resources in a callback tree, which is not composable.</li>
<li class="">Enforces <code>close</code> method name, renamed <code>UserProcessor#shutdown</code> to <code>close</code></li>
<li class="">Cannot run <code>suspend</code> functions within <code>fun close(): Unit</code>.</li>
<li class="">No exit signal; we don't know whether we exited successfully, with an error or cancellation.</li>
</ol>
<p><code>Resource</code> solves these issues. The main idea is that each resource has three
stages: 1️⃣ acquiring the resource, 2️⃣ using the resource, and 3️⃣ releasing the
resource. With <code>Resource</code>, we bundle steps (1) and (3), and the implementation
ensures that everything works correctly, even in the event of exceptions or
cancellations.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg xmlns=http://www.w3.org/2000/svg width=24 height=24 fill=none viewBox="0 0 24 24"><path fill=currentColor fill-rule=evenodd d="M1 12c0 6.075 4.925 11 11 11s11-4.925 11-11S18.075 1 12 1 1 5.925 1 12m8.793-4.293L14.086 12l-4.293 4.293 1.414 1.414 5-5 .707-.707-.707-.707-5-5z" clip-rule=evenodd /></svg></span>Graceful Shutdowns</div><div class=admonitionContent_BuS1><p>Correct release of resources when the application is terminating is important
in several scenarios.
<a class="" href=/learn/coroutines/suspendapp/>SuspendApp</a> improves on
<code>Resource</code> to gracefully deal with shutdown and termination.</div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=dealing-with-resources-properly>Dealing with resources properly<a href=#dealing-with-resources-properly class=hash-link aria-label="Direct link to Dealing with resources properly" title="Direct link to Dealing with resources properly" translate=no>​</a></h2>
<p>You can use Arrow's Resource in two ways:</p>
<ol>
<li class="">Using <code>resourceScope</code> and functions with <code>ResourceScope</code> as its receiver.</li>
<li class="">Wrapping the entire resource allocation and release as a <code>Resource&lt;A></code> value,
which we later <code>use</code> in a larger block.</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=using-resourcescope>Using <code>resourceScope</code><a href=#using-resourcescope class=hash-link aria-label="Direct link to using-resourcescope" title="Direct link to using-resourcescope" translate=no>​</a></h3>
<p>The <code>ResourceScope</code> DSL allows you to <em>install</em> resources and safely interact with them.
In fact, that's the only operation you need to learn about: <code>install</code> takes both
the acquisition and release steps as arguments. The result of this function is
whatever was acquired, plus the promise of running the finalizer at the end of
the block.</p>
<div class="theme-admonition theme-admonition-tip admonition_xJq3 alert alert--success"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg xmlns=http://www.w3.org/2000/svg width=24 height=24 fill=none viewBox="0 0 24 24"><path fill=currentColor fill-rule=evenodd d="M4.25 9a7.75 7.75 0 1 1 15.5 0v4.823l2.464 4.927H1.787l2.463-4.927zM10 23h4v-2h-4z" clip-rule=evenodd /></svg></span>tip</div><div class=admonitionContent_BuS1><p>The Resource DSL gives you enough flexibility to perform different actions
depending on how the execution finished: successful completion, exceptions,
or cancellation. The second argument to the finalizer is of type <code>ExitCase</code>
and represents the reason why the finalizer is run.</div></div>
<p>The code below shows our <code>example</code> rewritten to use <code>resourceScope</code>. Note that
we acquire our <code>UserProcessor</code> and <code>DataSource</code> in parallel, using the <a class="" href=/learn/coroutines/parallel/><code>parZip</code>
operation in Arrow</a>. This means that their <code>start</code> and <code>connect</code>
methods can run in parallel.</p>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#D4D4D4;--prism-background-color:#222E51><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style=color:#D4D4D4;background-color:#222E51><code class=codeBlockLines_e6Vv><span class=token-line style=color:#D4D4D4><span class="token keyword" style=color:#82a2f3>suspend</span><span class="token plain"> </span><span class="token keyword" style=color:#82a2f3>fun</span><span class="token plain"> ResourceScope</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>userProcessor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> UserProcessor </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token function" style=color:#EDB368>install</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>UserProcessor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>also</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> it</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>start</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _ </span><span class="token operator" style="color:rgb(212, 212, 212)">-></span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>shutdown</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain"></span><span class="token keyword" style=color:#82a2f3>suspend</span><span class="token plain"> </span><span class="token keyword" style=color:#82a2f3>fun</span><span class="token plain"> ResourceScope</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>dataSource</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> DataSource </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token function" style=color:#EDB368>install</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>DataSource</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>also</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> it</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>connect</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> ds</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _ </span><span class="token operator" style="color:rgb(212, 212, 212)">-></span><span class="token plain"> ds</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>close</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain"></span><span class="token keyword" style=color:#82a2f3>suspend</span><span class="token plain"> </span><span class="token keyword" style=color:#82a2f3>fun</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>example</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Unit </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> resourceScope </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token keyword" style=color:#82a2f3>val</span><span class="token plain"> service </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>parZip</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>userProcessor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>dataSource</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> userProcessor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ds </span><span class="token operator" style="color:rgb(212, 212, 212)">-></span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">    </span><span class="token function" style=color:#EDB368>Service</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ds</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> userProcessor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token keyword" style=color:#82a2f3>val</span><span class="token plain"> </span><span class="token keyword" style=color:#82a2f3>data</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> service</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>processData</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token function" style=color:#EDB368>println</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style=color:#82a2f3>data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br/></span></code></pre></div></div>
<p>The code above also showcases a very common pattern of resource acquisition:
running the constructor, followed by calling some start method using Kotlin's
<code>also</code> scope function.</p>
<div class="theme-admonition theme-admonition-note admonition_xJq3 alert alert--secondary"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg xmlns=http://www.w3.org/2000/svg width=24 height=24 fill=none viewBox="0 0 24 24"><path fill=currentColor fill-rule=evenodd d="M1 12c0 6.075 4.925 11 11 11s11-4.925 11-11S18.075 1 12 1 1 5.925 1 12m8.793-4.293L14.086 12l-4.293 4.293 1.414 1.414 5-5 .707-.707-.707-.707-5-5z" clip-rule=evenodd /></svg></span>note</div><div class=admonitionContent_BuS1><p>To achieve its behavior, <code>install</code> invokes the <code>acquire</code> and <code>release</code> steps
as <a href=https://kotlinlang.org/api/kotlinx.coroutines/kotlinx-coroutines-core/kotlinx.coroutines/-non-cancellable/ target=_blank rel="noopener noreferrer" class="">NonCancellable</a>.
If a cancellation signal or an exception is received during <code>acquire</code>, the
resource is assumed to <strong>not</strong> have been acquired and thus will not trigger the
release function; any composed resources that are already acquired are guaranteed
to be released as expected.</div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=interfacing-with-java>Interfacing with Java<a href=#interfacing-with-java class=hash-link aria-label="Direct link to Interfacing with Java" title="Direct link to Interfacing with Java" translate=no>​</a></h3>
<p>If you're running on the JVM, Arrow provides built-in integration with
<a href=https://docs.oracle.com/javase/8/docs/api/java/lang/AutoCloseable.html target=_blank rel="noopener noreferrer" class=""><code>AutoCloseable</code></a>
in the form of the <a href=https://apidocs.arrow-kt.io/arrow-fx-coroutines/arrow.fx.coroutines/closeable.html target=_blank rel="noopener noreferrer" class=""><code>closeable</code></a> function.</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id=using-resource>Using <code>Resource</code><a href=#using-resource class=hash-link aria-label="Direct link to using-resource" title="Direct link to using-resource" translate=no>​</a></h3>
<p>The usage of <code>resource</code> is very similar to that of <code>install</code>. The main difference
is that the result is a value of type <code>Resource&lt;T></code>, where <code>T</code> is the type of
the resource to acquire. But such a value doesn't run the acquisition step,
it's simply a <em>recipe</em> describing how that's done; to actually acquire the
resource, you need to call <code>.bind()</code> inside a <code>resourceScope</code>.</p>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#D4D4D4;--prism-background-color:#222E51><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style=color:#D4D4D4;background-color:#222E51><code class=codeBlockLines_e6Vv><span class=token-line style=color:#D4D4D4><span class="token keyword" style=color:#82a2f3>val</span><span class="token plain"> userProcessor</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Resource</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">UserProcessor</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>resource</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token function" style=color:#EDB368>UserProcessor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>also</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> it</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>start</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _ </span><span class="token operator" style="color:rgb(212, 212, 212)">-></span><span class="token plain"> p</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>shutdown</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain"></span><span class="token keyword" style=color:#82a2f3>val</span><span class="token plain"> dataSource</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Resource</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">DataSource</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>resource</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token function" style=color:#EDB368>DataSource</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>also</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> it</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>connect</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> ds</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> exitCase </span><span class="token operator" style="color:rgb(212, 212, 212)">-></span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token function" style=color:#EDB368>println</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal singleline string" style=color:#5B88F8>"Releasing </span><span class="token string-literal singleline interpolation interpolation-punctuation punctuation" style="color:rgb(212, 212, 212)">$</span><span class="token string-literal singleline interpolation expression" style=color:#b0bee3>ds</span><span class="token string-literal singleline string" style=color:#5B88F8> with exit: </span><span class="token string-literal singleline interpolation interpolation-punctuation punctuation" style="color:rgb(212, 212, 212)">$</span><span class="token string-literal singleline interpolation expression" style=color:#b0bee3>exitCase</span><span class="token string-literal singleline string" style=color:#5B88F8>"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token function" style=color:#EDB368>withContext</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Dispatchers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain">IO</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> ds</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>close</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain"></span><span class="token keyword" style=color:#82a2f3>val</span><span class="token plain"> service</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Resource</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">Service</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> resource </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token function" style=color:#EDB368>Service</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">dataSource</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>bind</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> userProcessor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>bind</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain" style=display:inline-block></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain"></span><span class="token keyword" style=color:#82a2f3>suspend</span><span class="token plain"> </span><span class="token keyword" style=color:#82a2f3>fun</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>example</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Unit </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> resourceScope </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token keyword" style=color:#82a2f3>val</span><span class="token plain"> </span><span class="token keyword" style=color:#82a2f3>data</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> service</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>bind</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>processData</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token function" style=color:#EDB368>println</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style=color:#82a2f3>data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br/></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg xmlns=http://www.w3.org/2000/svg width=24 height=24 fill=none viewBox="0 0 24 24"><path fill=currentColor fill-rule=evenodd d="M12 23c6.075 0 11-4.925 11-11S18.075 1 12 1 1 5.925 1 12s4.925 11 11 11M9 11.5h2v4H9v2h6v-2h-2v-6H9zM13 8V6h-2v2z" clip-rule=evenodd /></svg></span>info</div><div class=admonitionContent_BuS1><p><em>Why provide two ways to accomplish the same goal?</em>
Although <code>resourceScope</code> provides nicer syntax in general, some usage patterns
like acquiring several resources become easier when the steps are saved in
an actual class.<p>The actual magic is that <code>Resource</code> is nothing more than a type alias for
parameter-less function using <code>ResourceScope</code>,<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#D4D4D4;--prism-background-color:#222E51><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style=color:#D4D4D4;background-color:#222E51><code class=codeBlockLines_e6Vv><span class=token-line style=color:#D4D4D4><span class="token keyword" style=color:#82a2f3>typealias</span><span class="token plain"> Resource</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">A</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token keyword" style=color:#82a2f3>suspend</span><span class="token plain"> ResourceScope</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-></span><span class="token plain"> A</span><br/></span></code></pre></div></div></div></div>
<p>Although the primary usage pattern is to give <code>resource</code> the acquisition and
release steps directly, there's another way to define a <code>Resource&lt;T></code>.
Arrow provides a <code>resource</code> for more complex scenarios that takes a block
with <code>ResourceScope</code> as a receiver. That allows calling <code>install</code> as required.</p>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#D4D4D4;--prism-background-color:#222E51><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style=color:#D4D4D4;background-color:#222E51><code class=codeBlockLines_e6Vv><span class=token-line style=color:#D4D4D4><span class="token keyword" style=color:#82a2f3>val</span><span class="token plain"> userProcessor</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Resource</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">UserProcessor</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> resource </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token keyword" style=color:#82a2f3>val</span><span class="token plain"> x</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> UserProcessor </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>install</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain">  </span><span class="token function" style=color:#EDB368>UserProcessor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>also</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> it</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>start</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> processor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> _ </span><span class="token operator" style="color:rgb(212, 212, 212)">-></span><span class="token plain"> processor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token function" style=color:#EDB368>shutdown</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  x</span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br/></span></code></pre></div></div>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id=integration-with-typed-errors>Integration with typed errors<a href=#integration-with-typed-errors class=hash-link aria-label="Direct link to Integration with typed errors" title="Direct link to Integration with typed errors" translate=no>​</a></h2>
<p>Resource management cooperates with <a class="" href=/learn/typed-errors/>typed error builders</a>.
It's important to be aware that the order in which we open the scopes
affects the behavior. To be more concrete, let's consider the two possible
nestings of <code>resourceScope</code> and <code>either</code>.</p>
<ol>
<li class="">
<p>When <code>either</code> is in the outermost position and <code>resourceScope</code> is inside of it,
a bind that crosses the <code>resourceScope</code> results in the release finalizer
being called with <code>Cancelled</code>.</p>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#D4D4D4;--prism-background-color:#222E51><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style=color:#D4D4D4;background-color:#222E51><code class=codeBlockLines_e6Vv><span class=token-line style=color:#D4D4D4><span class="token plain">either</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> Int</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  resourceScope </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">    </span><span class="token keyword" style=color:#82a2f3>val</span><span class="token plain"> a </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>install</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> _</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> ex </span><span class="token operator" style="color:rgb(212, 212, 212)">-></span><span class="token plain"> </span><span class="token function" style=color:#EDB368>println</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal singleline string" style=color:#5B88F8>"Closing A: </span><span class="token string-literal singleline interpolation interpolation-punctuation punctuation" style="color:rgb(212, 212, 212)">$</span><span class="token string-literal singleline interpolation expression" style=color:#b0bee3>ex</span><span class="token string-literal singleline string" style=color:#5B88F8>"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">    </span><span class="token function" style=color:#EDB368>raise</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal singleline string" style=color:#5B88F8>"Boom!"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token comment" style=color:#6b738a>// Closing A: ExitCase.Cancelled</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token comment" style=color:#6b738a>// Either.Left(Boom!)</span><br/></span></code></pre></div></div>
</li>
<li class="">
<p>With reverse nesting order of <code>either</code> and <code>resourceScope</code>, then resources
are released with a normal state since nothing "failed."</p>
<div class="language-kotlin codeBlockContainer_Ckt0 theme-code-block" style=--prism-color:#D4D4D4;--prism-background-color:#222E51><div class=codeBlockContent_QJqH><pre tabindex=0 class="prism-code language-kotlin codeBlock_bY9V thin-scrollbar" style=color:#D4D4D4;background-color:#222E51><code class=codeBlockLines_e6Vv><span class=token-line style=color:#D4D4D4><span class="token plain">resourceScope </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  either</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">String</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> Int</span><span class="token operator" style="color:rgb(212, 212, 212)">></span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">    </span><span class="token keyword" style=color:#82a2f3>val</span><span class="token plain"> a </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style=color:#EDB368>install</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> _</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">ex </span><span class="token operator" style="color:rgb(212, 212, 212)">-></span><span class="token plain"> </span><span class="token function" style=color:#EDB368>println</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal singleline string" style=color:#5B88F8>"Closing A: </span><span class="token string-literal singleline interpolation interpolation-punctuation punctuation" style="color:rgb(212, 212, 212)">$</span><span class="token string-literal singleline interpolation expression" style=color:#b0bee3>ex</span><span class="token string-literal singleline string" style=color:#5B88F8>"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">    </span><span class="token function" style=color:#EDB368>raise</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string-literal singleline string" style=color:#5B88F8>"Boom!"</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token comment" style=color:#6b738a>// Either.Left(Boom!)</span><span class="token plain"></span><br/></span><span class=token-line style=color:#D4D4D4><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"> </span><span class="token comment" style=color:#6b738a>// Closing A: ExitCase.Completed</span><br/></span></code></pre></div></div>
</li>
</ol>
<p>We remark that, in both cases, resources are correctly released. If your
finalizer works in the same way for every possible <code>ExitCase</code>, then there's no
visible difference between them.</p>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class=admonitionHeading_Gvgb><span class=admonitionIcon_Rf37><svg xmlns=http://www.w3.org/2000/svg width=24 height=24 fill=none viewBox="0 0 24 24"><path fill=currentColor fill-rule=evenodd d="M12 23c6.075 0 11-4.925 11-11S18.075 1 12 1 1 5.925 1 12s4.925 11 11 11M9 11.5h2v4H9v2h6v-2h-2v-6H9zM13 8V6h-2v2z" clip-rule=evenodd /></svg></span>info</div><div class=admonitionContent_BuS1><p>If you want to know more, this <a href=https://kotlinlang.slack.com/archives/C5UPMM0A0/p1677093177834299 target=_blank rel="noopener noreferrer" class="">conversation</a>
in the Kotlin Slack goes into more detail.</div></div></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href=/learn/coroutines/racing/><div class=pagination-nav__sublabel>Previous</div><div class=pagination-nav__label>Racing</div></a><a class="pagination-nav__link pagination-nav__link--next" href=/learn/coroutines/suspendapp/><div class=pagination-nav__sublabel>Next</div><div class=pagination-nav__label>Graceful shutdown</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href=#understanding-the-problem class="table-of-contents__link toc-highlight">Understanding the problem</a><li><a href=#dealing-with-resources-properly class="table-of-contents__link toc-highlight">Dealing with resources properly</a><ul><li><a href=#using-resourcescope class="table-of-contents__link toc-highlight">Using <code>resourceScope</code></a><li><a href=#interfacing-with-java class="table-of-contents__link toc-highlight">Interfacing with Java</a><li><a href=#using-resource class="table-of-contents__link toc-highlight">Using <code>Resource</code></a></ul><li><a href=#integration-with-typed-errors class="table-of-contents__link toc-highlight">Integration with typed errors</a></ul></div></div></div></div></main></div></div></div><footer class=footer><div class="container container-fluid container_y1z5"><div><div class="margin-bottom--sm logo_cbK_"><a href=https://arrow-kt.io rel="noopener noreferrer" class=footerLogoLink_BH7S><img src=/img/arrow-brand.svg alt="Arrow Logo" class="footer__logo themedComponent_mlkZ themedComponent--light_NVdE" width=128 height=42 /><img src=/img/arrow-brand-dark.svg alt="Arrow Logo" class="footer__logo themedComponent_mlkZ themedComponent--dark_xIcU" width=128 height=42 /></a></div><small><div class=footer__copyright>Arrow is developed and maintained by the community</div></small></div><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class=footer__title></div><ul class="footer__items clean-list"><li class=footer__item><a href=https://apidocs.arrow-kt.io target=_blank rel="noopener noreferrer" class=footer__link-item>API Docs<svg width=13.5 height=13.5 aria-label="(opens in new tab)" class=iconExternalLink_nPIU><use href=#theme-svg-external-link /></svg></a><li class=footer__item><a class=footer__link-item href=/community/blog/>Blog</a><li class=footer__item><a class=footer__link-item href=/learn/projects/>Example projects</a></ul></div><div class="theme-layout-footer-column col footer__col"><div class=footer__title>Learn</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/learn/quickstart/>Quickstart</a><li class=footer__item><a class=footer__link-item href=/learn/typed-errors/>Typed errors</a><li class=footer__item><a class=footer__link-item href=/learn/coroutines/>Coroutines</a><li class=footer__item><a class=footer__link-item href=/learn/resilience/>Resilience</a></ul></div><div class="theme-layout-footer-column col footer__col"><div class=footer__title>...</div><ul class="footer__items clean-list"><li class=footer__item><a class=footer__link-item href=/learn/immutable-data/>Immutable data</a><li class=footer__item><a class=footer__link-item href=/learn/collections-functions/>Collections and functions</a><li class=footer__item><a class=footer__link-item href=/learn/design/>Design</a><li class=footer__item><a class=footer__link-item href=/learn/integrations/>Integrations</a></ul></div></div><ul class="clean-list container_dM9r"><li><a href=https://twitter.com/arrow_kt target=_blank rel="noopener noreferrer"><img src=/img/icon-social-twitter.svg alt=Twitter title=Twitter height=24px width=24px /></a><li><a href=https://slack-chats.kotlinlang.org/c/arrow target=_blank rel="noopener noreferrer"><img src=/img/icon-social-slack.svg alt=Slack title=Slack height=24px width=24px /></a><li><a href=https://github.com/arrow-kt target=_blank rel="noopener noreferrer"><img src=/img/icon-social-github.svg alt=GitHub title=GitHub height=24px width=24px /></a><li><a href=https://stackoverflow.com/questions/tagged/arrow-kt target=_blank rel="noopener noreferrer"><img src=/img/icon-social-stackoverflow.svg alt="Stack Overflow" title="Stack Overflow" height=24px width=24px /></a></li><div class=starsContainer_WEfU><div>Loading...</div></div></ul></div></footer></div></body>